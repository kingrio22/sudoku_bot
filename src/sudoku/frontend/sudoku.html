<!DOCTYPE html>
<html>
  <head>
    <style>
      @import url('https://fonts.googleapis.com/css?family=Comfortaa|Patrick+Hand|Quicksand&display=swap');
* {
  font-family: 'Comfortaa', cursive;
}

.cell {
  width: 60px;
  height: 60px;

  border: 0.2px solid black;
  padding: 0px;
  margin: 0px;

  align-items: center;
  font-size: 25px;
}

.mistake {
  background-color: red !important;
  color: white;
}
colgroup,
tbody {
  border: solid medium;
}

.given {
  color: red;
  font-weight: bold;
}
.hidden {
  display: none;
}
input {
  text-align: center;
  height: 100%;
  width: 100%;
  margin: 0;
  padding: 0;
  border: 0px solid;
  background-color: rgba(0, 0, 0, 0);
}
.input {
  background-color: rgba(255, 255, 255, 0.5);
  margin: 0;
  padding: 0;
}

.disabledInput {
  background-color: rgba(128, 128, 128, 0.226) !important;
  color: white;
}

.button {
  border-radius: 0px;
  border-width: 2px;
  border-style: solid;
  border-color: rgba(197, 197, 170);
  color: rgba(197, 197, 170);
  background-color: rgba(197, 197, 170, 0);
  font-weight: bolder;
  padding: 10px;
  margin-right: 30px;
  width: 100%;
  height: 50px;
}

.empty-error {
  height: 50px;
  margin-bottom: 10px;
  margin-top: 10px;
}
.error-line {
  background-color: rgba(134, 24, 24, 0.7);
}

.solve {
  background-color: green;
  color: white;
}
.cards {
  padding: 20px;
  margin-bottom: 50px;
  border-radius: 5px;
}

.edit {
  background-color: orange;
  color: white;
}
.leave-hidden {
  margin-top: 50px;
  color: rgba(197, 197, 170, 0);
  background-color: rgba(197, 197, 170, 0);
  border-color: rgba(197, 197, 170, 0);
}

.leave-show {
  margin-top: 50px;
  border-color: rgba(197, 197, 170);
  color: rgba(197, 197, 170);
  background-color: rgba(197, 197, 170, 0);
}

.even {
  background-color: rgba(118, 230, 127, 0.5);
}
.even .input {
  background-color: rgba(118, 230, 127, 0.2);
}
.sudoku {
  margin-top: 100px;
}

.navigation {
  background-color: rgba(0, 0, 0, 0.7);
  color: rgba(197, 197, 170, 0.719);
  padding: 20px;
}
.footer-self {
  background-color: rgba(0, 0, 0, 0.7);
  color: rgba(197, 197, 170, 1);
  padding: 20px;
  margin-top:100px; 
}

.hover:hover {
  background-color: rgba(197, 197, 170, 0.719);
  color: rgba(0, 0, 0, 0.7);
}

.button-col {
  vertical-align: middle;
  max-width: 70%;
}

.background {

}

.message-modal {
  width: 100%;
  height: 100%;
  position: absolute;
  display: none;
  justify-content: center;
  background-color: rgba(255, 255, 255, 0.3);
  align-items: center;
  z-index: 1; 
}
.modal-self {
  width: 450px;
  height: 250px;
  background-color: rgba(0, 0, 0, 0.85);
  border-width: 0px; 
  color: rgba(197, 197, 170);
  font-size: 25px;
  border-radius: 5px;
  position: relative;

}
.close-modal {
  position: absolute;
  color: red ; 

  top: 0;
  right: 22px;
  font-size: 42px ;
  transform: rotate(45deg);
  cursor: pointer;
}

.modal-custom-text{
  margin-top: 40px; 
}

.modal-buttons{
  margin-top: 40px; 
  display: none;
}
.button-modal{
  display: none;
}

.footer-icons{
  margin-top: 15px; 
  width: 50px;
  height: 50px;
}

    </style>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
  </head>

  <body>
    <div class="background" style="background-image: url('https://sudoku.kingrio22.io/background-sudoku.jpg');">
       <!-- Modal Section -->
       <div id="message-modal" class="message-modal">
        <div class="modal-self">
          <div id="close-modal" class="close-modal">+</div>
          <div class="row justify-content-center">
            <div class="col-10 modal-custom-text">
              <span id="modal-line-1"></span></br>
              <span id="modal-line-2"></span>
              <div class="row modal-buttons">
                <div class="col-6 text-center">
                  <button class="button hover button-modal" id="message-true"></button>
                </div>
                <div class="col-6 text-center">
                  <button class="button hover button-modal" id="message-false"></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal Section End-->
      <div class="navigation">
        <div class="container">
          <div class="row">
            <div class="col-3  text-center">
              <a href="/"><button id="home-button" class="button hover ">Home</button></a>
            </div>
            <div class="col-3 text-center">
             <a href="/id/2"><button id="new-sudoku" class="button hover">New Sudoku</button></a>
            </div>
            <div class="col-3 text-center">
             <button id="editbutton" class="button hover">Edit</button>
            </div>
            <div class="col-3 text-center">
             <button id="solvebutton" class="button hover">Solve</button>
            </div>
          </div>
        </div>
      </div>
      <div class="container">
      <div class="row justify-content-center sudoku">
        <div class="col-lg-7 col-12 cards" style="background-color: rgba(0, 0, 0,0.6);">
          <div class="row justify-content-center">
            <div class="col-auto empty-error text-center" style="margin-top: 10px;  color: rgba(197, 197, 170); font-size: 20px; ">
              <p id="showError" style="margin-top: 12px;"></p>
            </div>
          </div>
          <div class="row justify-content-center">
            <div class="col-auto">
              <table id="sudoku">
            <colgroup><col><col><col>
            <colgroup><col><col><col>
            <colgroup><col><col><col>
            <tbody>
              <tr>
                <td class="cell  given text-center">1</td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input  text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input  text-center"><input type="text"></td>
                <td class="cell even  input  text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input  text-center"><input type="text"></td>
                <td class="cell  given text-center">3</td>
              </tr>
              <tr>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input  text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even    given text-center">6</td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
              </tr>
              <tr>

                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell  given text-center">3</td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell  given text-center">1</td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
              </tr>
            </tbody>
              <tbody>
              <tr>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell  given text-center">7</td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell  given text-center">1</td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
              </tr>
              <tr>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input text-center"><input type="text"></td>
                <td class="cell even   given   text-center">8</td>
                <td class="cell even  input text-center  "><input type="text"></td>
                <td class="cell even  input text-center  "><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell  given text-center">5</td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
              </tr>
              <tr>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell  given text-center">3</td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell even     given text-center">4</td>
                <td class="cell input text-center"><input type="text"></td>
              </tr>
            </tbody>
            <tbody>
              <tr>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even     given text-center">8</td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even     given text-center">6</td>
                <td class="cell input  text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
              </tr>
              <tr>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell  given text-center">1</td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell even  input   text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
              </tr>
              <tr>
                <td class="cell even given text-center">6</td>
                <td class="cell even input text-center"><input type="text"></td>
                <td class="cell even input text-center"><input type="text"></td>
                <td class="cell even input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td class="cell input text-center"><input type="text"></td>
                <td  class="cell input text-center"><input type="text"></td>
                <td class="cell  given text-center">7</td>
              </tr>
            </tbody>
          </table>
         
          <div class="row justify-content-center">
             <div class="col-6 text-center">
              <button id="leavebutton" class="button hover leave-hidden">leave edit mode</button>
            </div>
          </div>
          </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-self">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-3 text-center">
            <p>Something to improove?</p>
            <p>Feel free and send an email:</p>
            <a href="mailto:support@kingrio22.io"><button id="email" class="button">support@kingrio22.io</button></a>
          </div>
           <!-- <div class="col-6 text-center">
            <p style="font-size: 20px;">Get in touch</p>
            <div class="row">
              <div class="col-4 text-center">
                <img class="footer-icons"src="../../github-icon.jpg">
               <img src="https://sudoku.kingrio22.io/github-icon.png">
              </div>
              <div class="col-4 text-center">
                <img class="footer-icons"src="../../linkedin-icon.jpg">
                   <img src="https://sudoku.kingrio22.io/xing-icon.png">
              </div>
              <div class="col-4 text-center">
                <img class="footer-icons"src="../../xing-icon.jpg">
                   <img src="https://sudoku.kingrio22.io/linkedin-icon.png">
              </div>
            </div
          </div>
         
          <div class="col-3">
            
          </div>>-->
        </div>
        <div class="row justify-content-center"style="margin-top:40px">
          <p>This page is still in work. More functions will come as soon as possible</p>
        </div>
      </div>
    </div>
    </div>
  </body>
  <script>
     const baseUrl = 'https://sudoku.kingrio22.io';

// document.querySelector('#home-button').addEventListener('click', homeButton)
// document.querySelector('#new-sudoku').addEventListener('click', newSudokuButton)
document.querySelector('#editbutton').addEventListener('click', editButton);
document.querySelector('#leavebutton').addEventListener('click', leaveEdit);
document.querySelector('#solvebutton').addEventListener('click', solveButton);
document.getElementById('close-modal').addEventListener('click', ()=>{
      document.querySelector('.message-modal').style.display = 'none'; 
    }); 

let button = document.getElementById('leavebutton');

if (button.classList.contains('leave-hidden')) {
  button.setAttribute('disabled', true);
  button.classList.remove('hover');
} else {
}

function homeButton(){
  showMessage('Are you sure?', 'All changes will be lost!', 'Yes', 'No').then(decission=>{
    if(decission){
      return; 
    }else{

    }
  })
}




function showMessage(firstLine, secondLine, messageTrue, messageFalse) {
  return new Promise(resolve => {

    let message = document.getElementById('message-modal');
    let buttonTrue = document.getElementById('message-true');
    let buttonFalse = document.getElementById('message-false');

    document.getElementById('modal-line-1').textContent = firstLine;
    document.getElementById('modal-line-2').textContent = secondLine;
  
    

    if(!messageTrue && !messageFalse){
      buttonTrue.style.display = 'none'; 
      buttonFalse.style.display = 'none'; 
    }else{
      buttonTrue.style.display = 'block'; 
      buttonFalse.style.display = 'block'; 
      buttonTrue.textContent = messageTrue;
      buttonFalse.textContent = messageFalse;
    }

    message.style.display = 'flex';

    buttonTrue.onclick = eve => {
      if (eve.isTrusted === true) {
        decission = true;
        message.style.display = 'none';
        resolve(true);
      }
    };
    buttonFalse.onclick = eve => {
      if (eve.isTrusted === true) {
        decission = false;
        message.style.display = 'none';
        resolve(false);
      }
    };
  });
}

function editButton() {
  showMessage('Are you sure?','All changes will be lost!', 'Yes', 'No').then(
    decission => {
      if (!decission) {
        return;
      }
      editMode();
    },
  );
}

function editMode() {
  let button = document.getElementById('leavebutton');
  if (button.classList.contains('leave-hidden')) {
    button.classList.remove('leave-hidden');
    button.disabled = false;
    console.log(button);
    button.classList.add('leave-show');
    button.classList.add('hover');
    let cells = document.getElementsByClassName('cell');

    for (const cell of cells) {
      cell.classList.remove('given', 'even', 'input');
      cell.firstChild.remove();
      let inputElem = document.createElement('input');
      inputElem.type = 'text';

      cell.appendChild(inputElem);
    }
  } else {
    button.disabled = true;
    button.classList.add('leave-hidden');
    button.classList.remove('hover');
    return;
  }
}

function solveButton() {
  showMessage('Are you sure?','All changes will be lost!', 'Yes', 'No').then(
    decission => {
      if (!decission) {
        return;
      }
      solveSudoku();
    },
  );
}

function solveSudoku() {
  let cells = document.getElementsByClassName('cell');
  let matrix = [];
  for (let i = 0; i < 9; i++) {
    matrix[i] = [];
    for (let j = 0; j < 9; j++) {
      let cell = cells[i * 9 + j];
      let given = false;
      for (classList of cell.classList) {
        if (classList === 'given') {
          given = true;
        }
      }
      if (cell.firstChild.value != '' && given) {
        matrix[i][j] = {
          value: parseInt(cell.firstChild.textContent),
          classList: cell.classList,
        };
      } else {
        matrix[i][j] = {
          value: 0,
          classList: cell.classList,
        };
      }
    }
  }
  let request = new XMLHttpRequest();
  let matrixForFill = undefined;

  request.open('POST', baseUrl + '/solve', true);
  request.setRequestHeader('content-type', 'application/json');
  request.send(JSON.stringify(matrix));
  request.onreadystatechange = () => {
    if (request.readyState === 4 && request.status === 201) {
      let response = JSON.parse(request.response);
      matrixForFill = response.result;

      for (let i = 0; i < cells.length; i++) {
        cells[i].textContent = matrixForFill[i].toString();
        if (cells[i].classList.contains('input')) {
          cells[i].style.color = '#FFFFFF';
        }
      }
    }
  };
}

function leaveEdit() {
  validateInputs();

  let cells = document.getElementsByClassName('cell');
  let matrix = [];
  let inputCounter = 0;
  let request = new XMLHttpRequest();
  for (let i = 0; i < cells.length; i++) {
    if (cells[i].firstChild.value != '') {
      inputCounter++;
    }
  }
  //minimale anzahl an given-elements die notwendig ist um ein sudoku lösen zu können
  if (inputCounter < 16) {
    showMessage(
      'Sudoku not solvable!','Continue with this one, or try new one?',
      'Continue',
      'Try new',
    ).then(decission => {
      if (!decission) {
        return;
      } else {
        editMode();
      }
    });
  } else {
    for (let i = 0; i < 9; i++) {
      matrix[i] = [];
      for (let j = 0; j < 9; j++) {
        let cell = cells[i * 9 + j];
        if (cell.firstChild.value != '') {
          matrix[i][j] = {
            value: parseInt(cell.firstChild.value),
            given: true,
            even: false,
          };
        } else {
          matrix[i][j] = {
            value: 0,
            given: false,
            even: false,
          };
        }
      }
    }
    request.open('POST', baseUrl + '/save', true);
    request.setRequestHeader('content-type', 'application/json');
    request.send(JSON.stringify(matrix));
    request.onreadystatechange = () => {
      if (request.readyState === 4) {
        if (request.status === 201) {
          console.log('response after save: ', request.response);

          for (let i = 0; i < cells.length; i++) {
            let cell = cells[i];
            if (cell.firstChild.value != '') {
              let value = cell.firstChild.value;
              cell.classList.add('given');
              cell.firstChild.remove();
              cell.textContent = value.toString();
            } else {
              cell.classList.add('input');
            }
            for (const button of buttons) {
              if (button.style.display === 'none') {
                button.style.display = 'block';
              } else {
                button.style.display = 'none';
              }
            }
          }
        } else {
          alert('sudoku not solvable');
        }
      }
    };
  }
}
validateInputs();

function showSuccessMessage() {
  showMessage('Congratulation!', 'Sudoku solved :)');
}

function validateInputs() {
  let cells = document.getElementsByClassName('cell');

  for (let i = 0; i < cells.length; i++) {
    cells[i].onchange = event => {
      let response = fillNewMatrix();
      let position = undefined;
      let errorElem = document.getElementById('showError');
      if (event.isTrusted) {
        if (isNaN(parseInt(cells[i].firstChild.value))) {
          errorElem.style.display = 'none';
          errorElem.parentElement.classList.remove('error-line');
          for (const value of values) {
            value.disabled = false;
            value.classList.remove('disabledInput');
            value.parentElement.classList.remove('disabledInput');
          }
          return;
        }
        let duplicateInput = false;
        let neededCol = extractColFromMatrix(
          response.matrix,
          response.changedCell.col,
        );
        if (hasDuplicates(response.matrix[response.changedCell.row])) {
          position = 'row';
          duplicateInput = true;
        } else if (hasDuplicates(neededCol)) {
          duplicateInput = true;
          position = 'col';
        } else if (
          checkNumbersInMiniSquare(
            response.matrix[response.changedCell.row][response.changedCell.col],
            response.changedCell.row,
            response.changedCell.col,
            response.matrix,
          )
        ) {
          duplicateInput = true;
          position = 'square';
        }

        if (
          parseInt(cells[i].firstChild.value) > 9 ||
          parseInt(cells[i].firstChild.value) < 1
        ) {
          duplicateInput = true;
          position = 'number out of range';
        }

        if (duplicateInput) {
          errorElem.textContent = `Last input results in ${position} error`;
          errorElem.parentElement.classList.add('error-line');
          errorElem.style.display = 'block';

          for (const value of values) {
            value.disabled = true;
            value.classList.add('disabledInput');
            value.parentElement.classList.add('disabledInput');
            console.log(value.parentElement);
          }
          cells[i].classList.remove('disabledInput');
          cells[i].firstChild.classList.remove('disabledInput');
          cells[i].firstChild.disabled = false;
        } else {
          errorElem.style.display = 'none';
          errorElem.parentElement.classList.remove('error-line');
          let lastElem = true;
          for (let i = 0; i < values.length; i++) {
            if (values[i].value === '') {
              lastElem = false;
              continue;
            }
          }
          if (lastElem) {
            showSuccessMessage();
          }
          for (const value of values) {
            value.disabled = false;
            value.classList.remove('disabledInput');
            value.parentElement.classList.remove('disabledInput');
          }
        }
      }
    };
  }
  let values = document.getElementsByTagName('input');
  for (let i = 0; i < values.length; i++) {
    values[i].oninput = value => {
      if (value.isTrusted) {
        if (values[i].value == '') {
          values[i].classList.remove('mistake');
        } else {
          if (
            (values[i].parentElement.classList[1] === 'even' &&
              values[i].value % 2 != 0) ||
            values[i].value > 9 ||
            values[i].value < 1
          ) {
            values[i].classList.add('mistake');
          } else {
            values[i].classList.remove('mistake');
          }
        }
      }
    };
  }
}
function hasDuplicates(array) {
  for (let i = 0; i < array.length; i++) {
    for (let j = 0; j < array.length; j++) {
      if (array[i] != '' && array[j] != '' && i != j) {
        if (array[i] === array[j]) {
          return true;
        }
      }
    }
  }
  return false;
}
function extractColFromMatrix(matrix, col) {
  let extractedCol = [];
  for (let i = 0; i < 9; i++) {
    extractedCol.push(matrix[i][col]);
  }
  console.log(extractedCol);
  return extractedCol;
}

function checkNumbersInMiniSquare(numberToCheck, x, y, matrix) {
  for (let i = x - (x % 3); i < x - (x % 3) + 3; i++) {
    for (let j = y - (y % 3); j < y - (y % 3) + 3; j++) {
      if (i === x && y === j) {
        continue;
      }
      if (matrix[i][j] != '') {
        if (matrix[i][j] === numberToCheck) {
          return true;
        }
      }
    }
  }
  return false;
}

function fillNewMatrix() {
  let counter = 0;
  let matrix = [];
  let changedCell = {
    row: undefined,
    col: undefined,
  };
  let cells = document.getElementsByClassName('cell');
  for (let i = 0; i < 9; i++) {
    matrix[i] = [];
    for (let j = 0; j < 9; j++) {
      let value;
      if (cells[i * 9 + j].firstElementChild) {
        counter++;
        value = parseInt(cells[i * 9 + j].firstChild.value);
        if (!isNaN(value)) {
          console.log('in if', value);
          changedCell.row = i;
          changedCell.col = j;
        }
      } else {
        value = cells[i * 9 + j].textContent;
      }
      if (isNaN(parseInt(value))) {
        matrix[i].push('');
        continue;
      }

      matrix[i].push(parseInt(value));
    }
  }
  console.log(counter);
  let response = {
    matrix: matrix,
    changedCell: changedCell,
  };
  return response;
}

  </script>
</html>
